
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description
     *   Regras para a coleção de submissões de formulário de contato.
     *   - Permite que qualquer pessoa crie um documento (envie o formulário),
     *     desde que os dados sejam válidos.
     *   - Permite que apenas usuários autenticados (admin) leiam os dados.
     */
    match /contactFormSubmissions/{contactFormSubmissionId} {

      /**
       * @description
       *   Permite a criação de um novo envio de formulário por qualquer pessoa (não autenticada),
       *   mas valida estritamente o schema dos dados. Isso funciona como um "dropbox" seguro.
       *   - Garante que a data de submissão seja o timestamp do servidor.
       *   - Valida os tipos de dados e a presença dos campos obrigatórios.
       */
      allow create: if request.auth == null
                      && request.resource.data.submissionDate == request.time
                      && request.resource.data.formType is string
                      && request.resource.data.name is string
                      && request.resource.data.email is string
                      && (!('phone' in request.resource.data) || request.resource.data.phone is string)
                      && (!('service' in request.resource.data) || request.resource.data.service is string)
                      && (!('companyName' in request.resource.data) || request.resource.data.companyName is string)
                      && (!('employeeCount' in request.resource.data) || request.resource.data.employeeCount is string)
                      && (!('companySite'in request.resource.data) || request.resource.data.companySite is string)
                      && (!('challenge' in request.resource.data) || request.resource.data.challenge is string)
                      && (!('goal' in request.resource.data) || request.resource.data.goal is string)
                      && (!('details' in request.resource.data) || request.resource.data.details is string)
                      && (!('howYouFoundUs' in request.resource.data) || request.resource.data.howYouFoundUs is string)
                      && (!('role' in request.resource.data) || request.resource.data.role is string)
                      && (!('department' in request.resource.data) || request.resource.data.department is string)
                      && (!('companyTime' in request.resource.data) || request.resource.data.companyTime is string)
                      && (!('message' in request.resource.data) || request.resource.data.message is string)
                      // Garante que nenhum campo extra seja enviado
                      && request.resource.data.keys().size() <= 16;


      /**
       * @description
       *   Permite a leitura de um documento individual (get) e a listagem de toda
       *   a coleção (list) apenas se o usuário estiver autenticado.
       *   Crucial para a página de admin.
       */
      allow get, list: if request.auth != null;
      
      /**
       * @description
       *   Ninguém pode atualizar ou deletar envios através do cliente.
       */
      allow update, delete: if false;
    }

    /**
     * @description
     *   Regras para a coleção de depoimentos. Estes dados são públicos.
     */
    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Gerenciado apenas pelo lado do servidor/admin
    }
  }
}
