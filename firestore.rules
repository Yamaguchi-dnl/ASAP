
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Valida os dados de uma submissão de formulário de contato.
     * Garante que os campos obrigatórios existam e que os tipos de dados estejam corretos.
     */
    function isContactFormSubmissionValid(data) {
      // Campos obrigatórios para qualquer tipo de formulário
      let requiredFields = ['formType', 'name', 'email', 'submissionDate'];
      let areRequiredFieldsPresent = data.keys().hasAll(requiredFields);

      // Validação de tipos de dados comuns
      let areTypesCorrect = data.formType is string &&
                             data.name is string &&
                             data.email is string &&
                             data.submissionDate is string;
      
      // Permite campos opcionais, mas verifica seus tipos se presentes
      let areOptionalTypesCorrect = 
        (!data.keys().hasAny(['phone']) || data.phone is string) &&
        (!data.keys().hasAny(['service']) || data.service is string) &&
        (!data.keys().hasAny(['companyName']) || data.companyName is string) &&
        (!data.keys().hasAny(['employeeCount']) || data.employeeCount is string) &&
        (!data.keys().hasAny(['companySite']) || data.companySite is string) &&
        (!data.keys().hasAny(['challenge']) || data.challenge is string) &&
        (!data-keys().hasAny(['goal']) || data.goal is string) &&
        (!data.keys().hasAny(['details']) || data.details is string) &&
        (!data.keys().hasAny(['howYouFoundUs']) || data.howYouFoundUs is string) &&
        (!data.keys().hasAny(['role']) || data.role is string) &&
        (!data.keys().hasAny(['department']) || data.department is string) &&
        (!data.keys().hasAny(['companyTime']) || data.companyTime is string);

      // Garante que apenas campos conhecidos sejam enviados
      let allowedFields = requiredFields.concat([
        'phone', 'service', 'companyName', 'employeeCount', 'companySite', 
        'challenge', 'goal', 'details', 'howYouFoundUs', 'role', 'department', 'companyTime'
      ]);
      let areOnlyAllowedFieldsPresent = data.keys().hasOnly(allowedFields);

      return areRequiredFieldsPresent && areTypesCorrect && areOptionalTypesCorrect && areOnlyAllowedFieldsPresent;
    }

    /**
     * @description
     *   Regras para a coleção de submissões de formulário de contato.
     *   Atua como um dropbox seguro. Qualquer visitante pode criar, mas ninguém
     *   pode ler, atualizar ou deletar dados pelo cliente.
     */
    match /contactFormSubmissions/{contactFormSubmissionId} {
      allow get, list, update, delete: if false;

      /**
       * @description
       *   Permite a criação se os dados forem válidos de acordo com a função de validação.
       * @principle
       *   Impõe validação de schema na escrita para garantir a integridade dos dados.
       */
      allow create: if isContactFormSubmissionValid(request.resource.data);
    }

    /**
     * @description
     *   Regras para a coleção de depoimentos. Estes dados são públicos.
     */
    match /testimonials/{testimonialId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Gerenciado apenas pelo lado do servidor/admin
    }
  }
}
